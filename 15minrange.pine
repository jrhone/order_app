// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © jrhone

// strategy("My strategy", overlay=true, margin_long=100, margin_short=100)
//@version=5
strategy("15-Minute Range Breakout Strategy with SL & TP (EST, First Hour)", overlay=true, pyramiding=1)

isNewDay = dayofmonth != dayofmonth[1]

// Define the session start and end time for the 15-minute range (EST)
sessionStart = timestamp("UTC-4", year, month, dayofmonth, 09, 30)
sessionEnd = timestamp("UTC-4", year, month, dayofmonth, 09, 45)

// Trading window: first hour after market open (09:30 - 10:30 EST)
tradingEndTime = timestamp("UTC-4", year, month, dayofmonth, 10, 30)

// Calculate the high and low of the initial 15-minute range
var float rangeHigh = na
var float rangeLow = na

float stop = na
float limit = na

// Detect if a new day has started
if (isNewDay)
    rangeHigh := na
    rangeLow := na

openingRange = time >= sessionStart and time <= sessionEnd

if (openingRange)
    rangeHigh := na(rangeHigh) ? high : math.max(rangeHigh, high)
    rangeLow := na(rangeLow) ? low : math.min(rangeLow, low)

// Define the stop loss and take profit in ticks
stopLossPoints = 40 // 60
takeProfitPoints = 40 // 1600

// Strategy entry conditions
// todo also check for wick thrus from above and below
enterLong = ta.crossover(high, rangeHigh) or (ta.crossunder(low, rangeHigh) and open > rangeHigh) // Long on breakout of range high
enterShort = ta.crossunder(low, rangeLow) or (ta.crossover(high, rangeLow) and open < rangeLow) // Short on breakdown of range low

// // Close the open position at the start of a new day
// if (isNewDay and strategy.opentrades > 0)
//     strategy.close("Close Position at New Day")

// Execute trades with stop loss and take profit, only during the first hour
if (time >= sessionStart and time <= tradingEndTime)
    if (enterLong)
        stop := rangeHigh - stopLossPoints * syminfo.mintick
        limit := rangeHigh + takeProfitPoints * syminfo.mintick
        toffset = 100 * syminfo.mintick
        tpoints = 100 * syminfo.mintick
        strategy.entry("Long", strategy.long, stop=stop, limit=limit)
        strategy.exit("SL/TP", from_entry = "Long", stop=stop, limit=limit, comment_profit ='TP', comment_loss='SL')
        strategy.exit("Trail", from_entry = "Long", trail_offset=toffset, trail_points=tpoints, comment_profit ='Trail TP', comment_loss='Trail SL')
    if (enterShort)
        stop := rangeLow + stopLossPoints * syminfo.mintick
        limit := rangeLow - takeProfitPoints * syminfo.mintick
        strategy.entry("Short", strategy.short, stop=stop, limit=limit)
        strategy.exit("SL/TP", from_entry = "Short", stop=stop, limit=limit, comment_profit ='TP', comment_loss='SL')

// Plot the range for visual reference
plot((time >= sessionStart and time <= tradingEndTime) ? rangeHigh : na, title="Range High", color=color.green, linewidth=2, style=plot.style_linebr)
plot((time >= sessionStart and time <= tradingEndTime) ? rangeLow : na, title="Range Low", color=color.red, linewidth=2, style=plot.style_linebr)
plotshape(time == sessionEnd, title="Opening range end", location=location.abovebar, color=color.blue, style=shape.cross)
plot(time, title="time", color=color.blue)
plot(sessionStart, title="sessionStart", color=color.blue)
plot(sessionEnd, title="sessionEnd", color=color.blue)
plot(tradingEndTime, title="tradingEndTime", color=color.blue)
plot(time >= sessionStart and time <= tradingEndTime ? 1 : 0, title="in ib", color=color.blue)
plot(stop, title="stop", color=color.red)
plot(limit, title="limit", color=color.green)
// Plot visual signs for trade entry
// plotshape(enterLong ? true : na, title="Long Entry", location=location.belowbar, color=color.green, style=shape.arrowup)
// plotshape(enterShort ? true : na, title="Short Entry", location=location.abovebar, color=color.red, style=shape.arrowdown)

// // Plot TP and SL lines for long positions
// plot(strategy.position_size > 0 ? rangeHigh + takeProfitPoints * syminfo.mintick : na, title="Long Take Profit", color=color.blue, linewidth=2, style=plot.style_linebr)
plot(strategy.position_size, title="position_size", color=color.blue)
// plotshape(strategy.position_size > 0 ? rangeHigh - stopLossPoints * syminfo.mintick : na, title="Long Stop Loss", color=color.yellow, style=shape.circle)

// // Plot TP and SL lines for short positions
// plot(strategy.position_size < 0 ? rangeLow - takeProfitPoints * syminfo.mintick : na, title="Short Take Profit", color=color.blue, linewidth=2, style=plot.style_linebr)
// plot(strategy.position_size < 0 ? rangeLow + stopLossPoints * syminfo.mintick : na, title="Short Stop Loss", color=color.red, linewidth=2, style=plot.style_linebr)